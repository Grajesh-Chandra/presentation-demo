# Kong Configuration Evolution

This document shows how the Kong configuration evolves through each step of the setup process.

## ğŸ“ Configuration Files

```
plugins/
â”œâ”€â”€ 01-kong-basic.yaml          # Basic routing only
â”œâ”€â”€ 02-kong-with-auth.yaml      # + Authentication & Rate Limiting
â”œâ”€â”€ 03-kong-with-ai-proxy.yaml  # + AI Services (Gemini & Ollama)
â””â”€â”€ 04-kong-complete.yaml       # + AI Security (Complete)
```

## ğŸ”„ Step-by-Step Evolution

### Step 1: Basic Routing (01-kong-basic.yaml)

**Generated by:** `scripts/03-configure-kong-basic.sh`

**What's Added:**
- 2 Services (demo-api-service, ai-router-service)
- 2 Routes (demo-api-route, ai-router-route)
- No authentication
- No plugins

**Purpose:** Test basic routing through Kong Gateway

**Apply Command:**
```bash
deck gateway sync \
  --konnect-control-plane-name="Kong-Demo" \
  --konnect-addr="https://in.api.konghq.com" \
  --konnect-token="YOUR_TOKEN" \
  plugins/01-kong-basic.yaml
```

**Test:** `scripts/04-test-with-kong.sh`

---

### Step 2: Authentication & Rate Limiting (02-kong-with-auth.yaml)

**Generated by:** `scripts/05-add-authentication.sh`

**What's Added:**
- 2 Consumers (demo-user, power-user)
- API Keys (demo-api-key-12345, power-key-67890)
- key-auth plugin on both routes
- rate-limiting plugin per consumer (10/min, 50/min)
- correlation-id plugin for request tracking

**Purpose:** Secure APIs with authentication and prevent abuse with rate limiting

**Apply Command:**
```bash
deck gateway sync \
  --konnect-control-plane-name="Kong-Demo" \
  --konnect-addr="https://in.api.konghq.com" \
  --konnect-token="YOUR_TOKEN" \
  plugins/02-kong-with-auth.yaml
```

**Test:** `scripts/06-test-authentication.sh`

**Key Changes:**
```yaml
# New Consumers
consumers:
  - username: demo-user
    keyauth_credentials:
      - key: demo-api-key-12345

# New Plugins
plugins:
  - name: key-auth
    route: demo-api-route
  - name: rate-limiting
    consumer: demo-user
    config:
      minute: 10
```

---

### Step 3: AI Services with AI Proxy (03-kong-with-ai-proxy.yaml)

**Generated by:** `scripts/07-add-ai-proxy.sh`

**What's Added:**
- 2 New Services (ollama-ai-service, gemini-ai-service)
- 4 New Routes (ollama-chat, gemini-chat, custom-ai-chat, custom-ai-health)
- ai-proxy plugin for Ollama (provider: llama2, model: mistral)
- ai-proxy plugin for Gemini (provider: gemini, model: gemini-2.5-flash)
- Separate health route (public, no auth)
- Protected AI routes (require API key)

**Purpose:** Add Kong Native AI Gateway capabilities

**Prerequisites:**
- Ollama installed and running (`ollama serve`)
- Mistral model pulled (`ollama pull mistral`)
- Gemini API key (optional)

**Apply Command:**
```bash
deck gateway sync \
  --konnect-control-plane-name="Kong-Demo" \
  --konnect-addr="https://in.api.konghq.com" \
  --konnect-token="YOUR_TOKEN" \
  plugins/03-kong-with-ai-proxy.yaml
```

**Test:** `scripts/08-test-ai-services.sh`

**Key Changes:**
```yaml
# New AI Service
services:
  - name: ollama-ai-service
    url: http://host.docker.internal:11434
    plugins:
      - name: ai-proxy
        config:
          route_type: llm/v1/chat
          model:
            provider: llama2
            name: mistral
            options:
              upstream_url: http://host.docker.internal:11434/v1/chat/completions
              llama2_format: ollama

# Separate Routes (Health vs Chat)
routes:
  - name: custom-ai-chat      # Protected
    paths: [/ai/custom]
  - name: custom-ai-health    # Public
    paths: [/ai/health]
```

---

### Step 4: Complete Security (04-kong-complete.yaml)

**Generated by:** `scripts/09-add-ai-security.sh`

**What's Added:**
- ai-prompt-guard plugin (blocks malicious prompts)
  - Blocks jailbreak attempts
  - Blocks prompt injection
  - Blocks DAN attacks
- response-transformer plugin (adds custom headers)
  - X-Powered-By: Kong-AI-Gateway
  - X-AI-Provider: Custom/Ollama/Gemini
- request-size-limiting plugin (10MB max payload)
- Enhanced correlation-id tracking

**Purpose:** Production-ready security for AI endpoints

**Apply Command:**
```bash
deck gateway sync \
  --konnect-control-plane-name="Kong-Demo" \
  --konnect-addr="https://in.api.konghq.com" \
  --konnect-token="YOUR_TOKEN" \
  plugins/04-kong-complete.yaml
```

**Test:** `scripts/10-test-security.sh`

**Key Changes:**
```yaml
# AI Security
plugins:
  - name: ai-prompt-guard
    route: custom-ai-chat
    config:
      allow_all_conversation_history: false

  - name: response-transformer
    service: custom-ai-router
    config:
      add:
        headers:
          - X-Powered-By:Kong-AI-Gateway
          - X-AI-Provider:Custom

  - name: request-size-limiting
    service: custom-ai-router
    config:
      allowed_payload_size: 10
      size_unit: megabytes
```

---

## ğŸ¯ Configuration Comparison

| Feature | 01-basic | 02-auth | 03-ai | 04-complete |
|---------|----------|---------|-------|-------------|
| **Services** | 2 | 2 | 4 | 4 |
| **Routes** | 2 | 2 | 6 | 6 |
| **Consumers** | 0 | 2 | 2 | 2 |
| **Authentication** | âŒ | âœ… | âœ… | âœ… |
| **Rate Limiting** | âŒ | âœ… | âœ… | âœ… |
| **AI Proxy** | âŒ | âŒ | âœ… | âœ… |
| **AI Security** | âŒ | âŒ | âŒ | âœ… |
| **Request Tracking** | âŒ | âœ… | âœ… | âœ… |
| **Size Limiting** | âŒ | âŒ | âŒ | âœ… |

## ğŸ”Œ Plugin Summary

### Plugins by Configuration

**01-kong-basic.yaml:**
- No plugins

**02-kong-with-auth.yaml:**
- key-auth (2 instances)
- rate-limiting (2 instances)
- correlation-id (1 instance)

**03-kong-with-ai-proxy.yaml:**
- All from 02-kong-with-auth.yaml
- ai-proxy (2 instances: Ollama + Gemini)
- key-auth (2 additional instances for AI routes)

**04-kong-complete.yaml:**
- All from 03-kong-with-ai-proxy.yaml
- ai-prompt-guard (1 instance)
- response-transformer (1 instance)
- request-size-limiting (1 instance)

## ğŸ“Š Routes by Configuration

### 01-kong-basic.yaml
```
GET/POST /api/demo/*    â†’ demo-api-service
GET/POST /ai/*          â†’ ai-router-service
```

### 02-kong-with-auth.yaml
```
GET/POST /api/demo/*    â†’ demo-api-service [ğŸ” key-auth]
GET/POST /ai/*          â†’ ai-router-service [ğŸ” key-auth]
```

### 03-kong-with-ai-proxy.yaml
```
GET/POST /api/demo/*           â†’ demo-api-service [ğŸ” key-auth]
POST     /ai/custom/*          â†’ custom-ai-router [ğŸ” key-auth]
GET      /ai/health            â†’ custom-ai-router [ğŸŒ public]
POST     /ai/kong/ollama/chat  â†’ ollama-ai-service [ğŸ” key-auth] [ğŸ¤– ai-proxy]
POST     /ai/kong/gemini/chat  â†’ gemini-ai-service [ğŸ” key-auth] [ğŸ¤– ai-proxy]
```

### 04-kong-complete.yaml
```
Same as 03-kong-with-ai-proxy.yaml + security plugins
```

## ğŸš€ Usage Flow

1. **Start Simple:** Apply `01-kong-basic.yaml` to test routing
2. **Add Security:** Apply `02-kong-with-auth.yaml` to require API keys
3. **Enable AI:** Apply `03-kong-with-ai-proxy.yaml` to add AI capabilities
4. **Production Ready:** Apply `04-kong-complete.yaml` for complete security

Each configuration is **complete and standalone** - you don't need to apply them incrementally. Each file contains everything needed for that stage.

## ğŸ” Testing Each Stage

After applying each configuration:

| Config | Test Script | What It Tests |
|--------|-------------|---------------|
| 01-basic | `04-test-with-kong.sh` | Basic routing works |
| 02-auth | `06-test-authentication.sh` | Auth & rate limiting work |
| 03-ai | `08-test-ai-services.sh` | AI services respond |
| 04-complete | `10-test-security.sh` | Security blocks threats |

## ğŸ“ Notes

- All configs use Kong Konnect format (`_format_version: "3.0"`)
- Control plane name: `Kong-Demo`
- Region: India (`https://in.api.konghq.com`)
- All services use `host.docker.internal` to reach Kubernetes port-forwards
- Health endpoint (`/ai/health`) is always public (no auth required)
- AI endpoints require both authentication AND valid API keys
