_format_version: "3.0"
_konnect:
  control_plane_name: Kong-Demo

services:
  # Kong Native AI - Ollama (Mistral)
  - name: ollama-ai-service
    url: http://host.docker.internal:11434
    tags:
      - ai-gateway
      - native
      - ollama
    routes:
      - name: ollama-chat-route
        paths:
          - /ai/kong/ollama/chat
        strip_path: false
        methods:
          - POST
        tags:
          - kong-ai
          - ollama
    plugins:
      - name: ai-proxy
        config:
          route_type: llm/v1/chat
          model:
            provider: llama2
            name: mistral
            options:
              upstream_url: http://host.docker.internal:11434/v1/chat/completions
              llama2_format: openai
          logging:
            log_statistics: true
            log_payloads: false

  # Kong Native AI - Google Gemini
  - name: gemini-ai-service
    url: https://generativelanguage.googleapis.com
    tags:
      - ai-gateway
      - native
      - gemini
    routes:
      - name: gemini-chat-route
        paths:
          - /ai/kong/gemini/chat
        strip_path: false
        methods:
          - POST
        tags:
          - kong-ai
          - gemini
    plugins:
      - name: ai-proxy
        config:
          route_type: llm/v1/chat
          model:
            provider: gemini
            name: gemini-2.5-flash
          auth:
            header_name: x-goog-api-key
            header_value: "AIzaSyAR5tOATz7L-NfG2jTHuvw0WNyYwqxTwoA"
          logging:
            log_statistics: true
            log_payloads: false

  # Demo API Service
  - name: demo-api-service
    url: http://host.docker.internal:3000
    tags:
      - demo-api
    routes:
      - name: demo-api-route
        paths:
          - /api/demo
        strip_path: true

  # AI Router Service (Custom Flask App)
  - name: ai-router-service
    url: http://host.docker.internal:8080
    tags:
      - ai-router
      - custom
    routes:
      - name: ai-router-route
        paths:
          - /ai/custom
        strip_path: true
        methods:
          - GET
          - POST
        tags:
          - custom-ai

      - name: ai-health-route
        paths:
          - ~/ai/health$
        strip_path: false
        methods:
          - GET
        tags:
          - health
          - public
        plugins:
          - name: request-transformer
            config:
              replace:
                uri: /health

# Consumers
consumers:
  - username: demo-user
    custom_id: user-001
    keyauth_credentials:
      - key: demo-api-key-12345

  - username: power-user
    custom_id: user-002
    keyauth_credentials:
      - key: power-key-67890

# Plugins
plugins:
  # Key Authentication
  - name: key-auth
    route: demo-api-route
    config:
      key_names: [apikey]
      hide_credentials: true

  - name: key-auth
    route: ai-router-route
    config:
      key_names: [apikey]
      hide_credentials: true

  - name: key-auth
    route: ollama-chat-route
    config:
      key_names: [apikey]
      hide_credentials: true

  - name: key-auth
    route: gemini-chat-route
    config:
      key_names: [apikey]
      hide_credentials: true

  # Rate Limiting
  - name: rate-limiting
    consumer: demo-user
    config:
      minute: 10
      hour: 100
      policy: local

  - name: rate-limiting
    consumer: power-user
    config:
      minute: 50
      hour: 500
      policy: local

  # Correlation ID
  - name: correlation-id
    config:
      header_name: X-Request-ID
      generator: uuid
      echo_downstream: true
